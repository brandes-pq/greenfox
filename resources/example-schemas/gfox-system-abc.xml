<?xml version="1.0" encoding="UTF-8"?>
<greenFox xmlns="http://www.greenfox.org/ns/schema" greenfoxURI="http://www.greenfox.org/ns/schema-examples">
    <context>
        <field name="lastModified" value="2019-12-01"/>
    </context>    
    <domain path="\tt\greenfox\resources\example-system" label="system-abc">    
        
        <!-- *** Root folder containing the test system *** -->
        <folder foxpath="system-abc"> 
            <targetSize msg="Expecting exactly one folder 'system-abc" count="1"/>
            
            <!-- *** Folder containing a single test *** -->
            <folder foxpath=".\\test-*[input][output][config]">
                <targetSize msg="Test system without tests" minCount="1"/>
                
                <!-- ===================
                      X M L   t e s t s 
                     =================== -->
                
                <!-- *** XML input folder (containing request messages) *** -->
                <folder foxpath="input[*.xml]">
                    
                    <!-- *** XML request message *** -->
                    <file foxpath="*">
                        <targetSize msg="Input folder without request msgs" minCount="1"/>
                        
                        <!-- Critical check - for each request a successful response ? -->
                        <foxpath msg="Request without matching response" eq="true" expr="
                            let $expFileNameRS := file-name(.) ! replace(., 'RQ.xml$', 'RS.xml')                            
                            let $expRootNameRS := ./local-name(*) ! replace(., 'RQ$', 'RS')
                            let $actRootNameRS := ..\..\output\*[file-name(.) eq $expFileNameRS]/local-name(*)
                            return 
                                $expRootNameRS = $actRootNameRS" />          
                    </file>
                </folder>
                
                <!-- *** XML output folder (containing response messages) *** -->                
                <folder foxpath="output[*.xml]">
                    
                    <!-- *** XML response message *** -->                    
                    <file foxpath="*">
                        <!-- *** Check - response not stale? *** -->
                        <lastModified msg="Stale output file" ge="${lastModified}"/>
                        
                        <!-- *** Critical check - return code ok? *** -->
                        <xpath msg="Return code indicates error" expr="//*:returnCode" matches="^(OK|NOTFOUND)$"/>
                    </file>
                </folder>
                
                <!--  =====================
                       J S O N   t e s t s 
                      ===================== -->
                
                <!-- *** JSON input folder (containing request messages) *** -->                
                <folder foxpath="input[*.json]">
                    
                    <!-- *** JSON request message *** -->                    
                    <file foxpath="*" mediatype="json">
                        <targetSize msg="Input folder without request msgs" minCount="1"/>
                        
                        <!-- *** Critical check - for each request a successful response ? *** -->
                        <foxpath msg="Request without matching response" eq="true" expr="
                            let $expFileNameRS := file-name(.) ! replace(., 'RQ.json$', 'RS.json')                            
                            let $expRootNameRS := $jdoc/*/local-name(*) ! replace(., 'RQ$', 'RS')
                            let $actRootNameRS := ..\..\output\*[file-name(.) eq $expFileNameRS]\json-doc(.)/*/local-name(*)
                            return 
                                $expRootNameRS = $actRootNameRS" />                        
                    </file>
                </folder>               
                
                <!-- *** JSON output folder (containing response messages) *** -->
                <folder foxpath="output[*.json]">
                    
                    <!-- *** JSON response message *** -->                    
                    <file foxpath="*" mediatype="json">
                        <!-- *** Check - response not stale? *** -->
                        <lastModified msg="Stale output file" ge="${lastModified}"/>
                        
                        <!-- *** Critical check - return code ok? *** -->                        
                        <xpath msg="Return code should be OK or NOTFOUND" expr="//*:returnCode" matches="^(OK|NOTFOUND)$"/>
                    </file>
                </folder>
            </folder>
        </folder>
    </domain>    
</greenFox>
