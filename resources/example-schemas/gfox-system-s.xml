<?xml version="1.0" encoding="UTF-8"?>
<greenfox xmlns="http://www.greenfox.org/ns/schema" greenfoxURI="http://www.parsqube.de/ns/greenfox-schema/examples/system-s">
    <context>
        <field name="lastModified" value="2019-12-01"/>
    </context>    
    <domain path="\tt\greenfox\resources\example-system\system-s" label="system-s">    
        
        <!-- *** Root folder containing the test system *** -->
        <folder foxpath="."> 
            <targetSize msg="Expecting exactly one folder 'system-s" count="1"/>
            
            <!-- *** XSD folder -->
            <folder foxpath=".\\xsd">
                <targetSize msg="No XSD folder found" count="1"/>
                <file foxpath="*.xsd">
                    <targetSize msg="No XSDs found" minCount="1"/>
                </file>
            </folder>                

            <!-- *** Codelist folder -->
            <folder foxpath=".\\codelists">
                <targetSize msg="No codelist folder found" count="1"/>
                <foxpath expr="*.xml/codelist[entry/@code/string()]/@name" minCount="1"/>
            </folder>                
            
            <!-- *** Test case folders *** -->
            <folder foxpath=".\\test-*[input][output][config]">
                <targetSize msg="System without test cases" minCount="1"/>
                
                <folder foxpath="config">
                    <targetSize msg="Config folder missing." count="1"/>
                    
                    <file foxpath="msg-config.csv" mediatype="csv" csv.withHeader="yes">
                        <targetSize msg="Config file missing" count="1"/>

                        <!-- Check - configured return codes ok? -->
                        <xpath msg="Config file contains unknown return code" expr="//returnCode">
                            <in>
                                <eq>OK</eq>
                                <eq>NOFIND</eq>
                                <like>ERROR_*</like>
                            </in>                                
                        </xpath>
                        
                    </file>
                </folder>
                
                <!-- ===================
                      X M L   t e s t s 
                     =================== -->
                
                <!-- *** XML input folder (containing request messages) *** -->
                <folder foxpath="input[*.xml]">
                    
                    <!-- *** XML request message *** -->
                    <file foxpath="*">
                        <targetSize msg="Input folder without request msgs" minCount="1"/>
                        
                        <!-- Check - request with response ? -->
                        <foxpath msg="Request without response" count="1" expr="
                            let $expFileNameRS := file-name(.) ! replace(., 'RQ(\d*).xml$', 'RS$1.xml')    
                            return ..\..\output\*[file-name(.) eq $expFileNameRS]" />
                    </file>
                </folder>
                
                <!-- *** XML output folder (containing response messages) *** -->                
                <folder foxpath="output[*.xml]">
                    
                    <!-- *** XML response message *** -->                    
                    <file foxpath="*">
                        <!-- *** Check - response fresh? *** -->
                        <lastModified msg="Stale output file" ge="${lastModified}"/>                        

                        <!-- *** Check - XSD valid? -->
                        <xsdValid msg="Response msg not XSD valid" 
                                  xsdFoxpath="$domain\resources\xsd\\*.xsd"/>
                        
                        <!-- *** Check - known article number? -->                        
                        <xpath msg="Unknown foo article number"
                               expr="//*:fooValue" 
                               inFoxpath="$domain\\codelists\*.xml/codelist[@name eq 'foo-article']/entry/@code"/>
                        
                        <!-- *** getFooRS - status OK, yet no foo values -->
                        <xpath msg="getFoo*.xml OK but contains no fooValue" eq="true" 
                               expr="if (*:getFooRS//*:returnCode eq 'OK') then exists(//*:fooValue) else true()"/>
                        
                        <!-- *** Check - return code ok? *** -->
                        <foxpath msg="Return code not the configured value" eq="true" expr="
                            let $actReturnCode := doc(.)//*:returnCode
                            let $expReturnCode :=
                            let $fileName := file-name(.)
                            let $cfgDoc := ..\..\config\msg-config.csv\csv-doc(., ',', 'yes')
                            return $cfgDoc//record[response eq $fileName]/returnCode                            
                            return $actReturnCode = $expReturnCode"/>
                        
                    </file>
                    
                    
                </folder>
                
                <!--  =====================
                       J S O N   t e s t s 
                      ===================== -->
                
                <!-- *** JSON input folder (containing request messages) *** -->                
                <folder foxpath="input[*.json]">
                    
                    <!-- *** JSON request message *** -->                    
                    <file foxpath="*" mediatype="json">
                        <targetSize msg="Input folder without request msgs" minCount="1"/>
                        
                        <!-- *** Check - request with response ? *** -->
                        <foxpath msg="Request without response" count="1" expr="
                            let $expFileNameRS := file-name(.) ! replace(., 'RQ(\d*).json$', 'RS$1.json')    
                            return ..\..\output\*[file-name(.) eq $expFileNameRS]" />
                    </file>
                </folder>               
                
                <!-- *** JSON output folder (containing response messages) *** -->
                <folder foxpath="output[*.json]">
                    
                    <!-- *** JSON response message *** -->                    
                    <file foxpath="*" mediatype="json">
                        <!-- *** Check - response fresh? *** -->
                        <lastModified msg="Stale output file" ge="${lastModified}"/>

                        <!-- *** Check - known article number? -->
                        <xpath msg="Unknown foo article number"
                               expr="//fooValue" 
                               inFoxpath="$domain\\codelists\*.xml/codelist[@name eq 'foo-article']/entry/@code"/>                        

                        <!-- *** getFooRS - status OK, yet no foo values -->
                        <xpath msg="getFoo*.xml OK but contains no fooValue" eq="true" 
                            expr="if (json/*:getFooRS//*:returnCode eq 'OK') then exists(//*:fooValue) else true()"/>
                        
                        <!-- *** Check - return code ok? *** -->                        
                        <foxpath msg="Return code != configured value" eq="true" expr="
                            let $actReturnCode := json-doc(.)//*:returnCode
                            let $expReturnCode :=
                            let $fileName := file-name(.)
                            let $cfgDoc := ..\..\config\msg-config.csv\csv-doc(., ',', 'yes')
                            return $cfgDoc//record[response eq $fileName]/returnCode                            
                            return $actReturnCode = $expReturnCode"/>    
                        
                    </file>
                </folder>
            </folder>
        </folder>
    </domain>    
</greenfox>
