<?xml version="1.0" encoding="UTF-8"?>
<greenfox greenfoxURI="http://www.greenfox.org/ns/schema-examples/system-s"
    xmlns="http://www.greenfox.org/ns/schema">

    <!-- *** External context *** -->
    <context>
        <field name="lastModified" value="2019-12-01"/>
    </context>

    <!-- *** System file tree *** -->
    <domain path="\tt\greenfox\resources\example-system\system-s" name="system-s">

        <!-- *** System root folder shape *** -->
        <folder foxpath="." id="systemRootFolderShape">
            <!-- *** XSD folder shape *** -->
            <folder foxpath=".\\resources\xsd" id="xsdFolderShape">
                <targetSize countMsg="No XSD folder found" count="1"/>
                <file foxpath="*.xsd" id="xsdFileShape">
                    <targetSize minCountMsg="No XSDs found" minCount="1"/>
                </file>
            </folder>

            <!-- *** Codelist folder shape *** -->
            <folder foxpath=".\\resources\codelists" id="codelistFolderShape">
                <targetSize countMsg="No codelist folder found" count="1"/>

                <!-- # Check - folder contains codelists? -->
                <foxpath 
                    expr="*.xml/codelist[entry/@code[string()]]/@name"
                    minCount="1"
                    minCountMsg="Codelist folder without codelists"/>
                <file foxpath="*[is-xml(.)]" id="codelistFileShape">
                    <targetSize minCountMsg="No codelist files found" minCount="1"/>
                </file>
            </folder>

            <!-- *** Testcase folder shape *** -->
            <folder foxpath=".\\test-*[input][output][config]" id="testcaseFolderShape">
                <targetSize minCountMsg="No testcase folders found" minCount="1"/>
                <!-- # Check - test folder content ok? -->
                <folderContent
                    closedMsg="Testcase contains member other than input, output, config, log-*."
                    closed="true">
                    <memberFolders names="input, output, config"/>
                    <memberFiles names="log-*" count="*"/>
                </folderContent>

                <!-- *** msg config shape *** -->
                <file foxpath="config\msg-config.csv" id="msgConfigFileShape"
                      mediatype="csv" csv.separator="," csv.withHeader="yes">
                    <targetSize countMsg="Config file missing" count="1"/>

                    <!-- # Check - configured return codes expected? -->
                    <xpath expr="//returnCode" 
                           inMsg="Config file contains unknown return code">
                        <in>
                            <eq>OK</eq>
                            <eq>NOFIND</eq>
                            <like>ERROR_*</like>
                        </in>
                    </xpath>
                </file>

                <!-- *** Request file shape *** -->
                <file foxpath="input\(*.xml, *.json)" id="requestFileShape">
                    <targetSize minCountMsg="Input folder without request msgs" minCount="1"/>

                        <!-- # Check - request with response? -->
                    <foxpath 
                        expr="..\..\output\*\file-name(.)"
                        containsXPath="$fileName ! replace(., '(.*)RQ(.*)$', '$1RS$2')"
                        containsXPathMsg="Request without response"/>
                </file>

                <!-- *** Response file shape *** -->
                <file foxpath="output\(*.xml, *.json)" id="responseFileShape"
                      mediatype="xml-or-json">
                    <targetSize minCountMsg="Output folder without request msgs" minCount="1"/>

                    <!-- # Check - response fresh? -->
                    <lastModified geMsg="Stale output file" ge="${lastModified}"/>

                    <!-- # Check - response non-empty? -->
                    <fileSize gtMsg="Empty output file" gt="0"/>

                    <!-- # Check - schema valid? (only if XML) -->
                    <ifMediatype eq="xml">
                        <xsdValid xsdFoxpath="$domain\resources\xsd\\*.xsd"
                                  msg="Response msg not XSD valid"/>
                                  
                    </ifMediatype>

                    <!-- # Check - known article number? -->
                    <xpath 
                        expr="//*:fooValue"
                        eqFoxpath="$domain\\codelists\*.xml/codelist[@name eq 'foo-article']/entry/@code"
                        eqFoxpathMsg="Unknown foo article number" id="articleNumberValueShape"/>

                    <!-- # Check - return code ok? -->
                    <foxpath 
                        expr="..\..\config\msg-config.csv\csv-doc(., ',', 'yes')
                              //record[response eq $fileName]/returnCode"
                        eqXPath="//*:returnCode"                                   
                        eqXPathMsg="Return code not the configured value"/>                                   

                </file>

            </folder>
        </folder>
    </domain>
</greenfox>
