<?xml version="1.0" encoding="UTF-8"?>
<greenfox greenfoxURI="http://www.greenfox.org/ns/schema-examples/example-folder-content"
    xmlns="http://www.greenfox.org/ns/schema" xmlns:ex="http://example.com/ns">

    <!-- *** External context *** -->
    <context>
        <field name="domain" value="\tt\greenfox\resources\example-schemas"/>
        <field name="gfox" value="gfox-system-s.xml"/>
    </context>

    <!-- *** Constraint components *** -->
    <constraintComponents>
        
        <!-- Constraint component: all attributes are allowed -->
        <constraintComponent 
            constraintElementName="ex:allowedAtts"
            validatorXPath="@*/local-name(.)[not(. = tokenize($attNames))]">
            <param name="attNames"/>
        </constraintComponent>

        <!-- Constraint component: all mandatory attributes are present -->
        <constraintComponent 
            constraintElementName="ex:mandatoryAtts">
            <param name="attNames"/>
            <validatorXPath><![CDATA[
let $atts := @*/local-name(.) 
return tokenize($attNames)[not(. = $atts)]
            ]]></validatorXPath>
        </constraintComponent>

        <!-- Constraint component: exactly one attribute from a list of attribute -->
        <constraintComponent constraintElementName="ex:xoneAtts">
            <param name="attNames"/>
            
            <validatorXPath><![CDATA[
let $atts := @*/local-name(.)[. = tokenize($attNames)]
return
    if (count($atts) eq 1) then ()
    else if (count($atts) lt 1) then false()
    else $atts
            ]]></validatorXPath>
        </constraintComponent>

        <!-- Constraint component: at least one attribute from a list -->
        <constraintComponent 
            constraintElementName="ex:oneOrMoreAtts"
            validatorXPath="0 lt count(@*/local-name(.)[. = tokenize($attNames)])">
            <param name="attNames"/>
        </constraintComponent>

        <!-- Constraint component: all elements are allowed -->
        <constraintComponent 
            constraintElementName="ex:allowedElems"
            validatorXPath="*/local-name(.)[not(. = tokenize($elemNames))]">
            <param name="elemNames"/>
        </constraintComponent>

        <!-- Constraint component: element must be empty -->
        <constraintComponent constraintElementName="ex:emptyElem"
                             validatorXPath="*/local-name(.)"/>
        
        <!-- Constraint components: element must not have attributes -->        
        <constraintComponent constraintElementName="ex:noAtts"
                             validatorXPath="@*/local-name(.)"/>        
    </constraintComponents>


    <domain path="${domain}" name="schema-schemas">

        <!-- *** System root folder shape *** -->
        <folder foxpath="." id="schemasFolderShape">
            <targetSize msg="No schemas folder found" minCount="1"/>
            <file foxpath="${gfox}">
                <targetSize msg="system-s schema not found" minCount="1"/>

                <!-- check generic attributes 
                     ======================== -->
                <!-- check @id -->
                <focusNode xpath="//*[@id]">
                    <xpath description="Validates the @id attributes " expr="@id" datatype="NCName"
                        datatypeMsg="Invalid @id - value must be an NCName"
                        datatypeMsgOK="OK - @id attributes: no values which are not NCNames"
                        deactivated="false"/>
                </focusNode>

                <!-- check <greenfox>
                     ================ -->
                <focusNode xpath="*:greenfox">
                    <targetSize count="1" 
                                countMsg="No 'greenfox' root element"/>
                    
                    <!-- check namespace of root element -->
                    <xpath expr="namespace-uri(.)"
                           eq="http://www.greenfox.org/ns/schema"
                           eqMsg="Greenfox element has incorrect namespace; should be: http://www.greenfox.org/ns/schema-examples/system-s"
                           eqMsgOK="Greenfox element has correct namespace"/>
                
                    <!-- check child element names -->
                    <ex:allowedElems 
                        elemNames="context constraintComponents domain"
                        msg="Unexpected elements in 'greenfox' element; expected: $elemNames"
                        msgOK="OK - 'greenfox' element: no unexpected child elements"/>
                
                    <!-- check <context>
                     =================== -->
                    <focusNode xpath="*:context">
                        
                        <!-- check attribute names and mandatory attributs -->                            
                        <ex:noAtts
                            msg="Unexpected attributes in 'context' element - no attributes allowed"
                            msgOK="OK - 'context' element: no attributes"/>

                        <!-- check child element names -->
                        <ex:allowedElems 
                            elemNames="field"
                            msg="Unexpected child element in 'context' element: only 'field' children allowed"
                            msgOK="OK - 'context' element: child element names"/>
                        
                        <!-- check <field>
                        ================== -->
                        <focusNode xpath="*:field">
                            
                            <!-- check attribute names and mandatory attributs -->                            
                            <ex:allowedAtts attNames="name value"
                                msg="Unexpected attributes in 'field' element; expected: name, value"
                                msgOK="OK - 'field' element: no unexpected attributes"/>
                            
                            <!-- check mandatory attributes -->
                            <ex:mandatoryAtts attNames="name" msg="Missing mandatory attribute 'name'"
                                msgOK="OK - 'field' element: element has mandatory 'name' attribute"/>
                            
                            <!-- check @name: type must be NCName -->
                            <xpath description="Validates the @name attribute in 'field' elements"
                                expr="@name" datatype="NCName"
                                datatypeMsg="Unexpected datatype of @name in 'field' element; expected type is 'NCName'"
                                datatypeMsgOK="OK - 'field' element: no @name with type ne NCName"
                                deactivated="false"/>
                            
                        </focusNode>                        
                    </focusNode>                    
                </focusNode>
                
                <!-- check <constraintComponents>
                     ============================ -->
                <focusNode xpath="*:greenfox/*:constraintComponents">
                    <targetSize maxCount="1" maxCountMsg="At most one 'constraintComponents' element allowed"/>
                    <ex:noAtts
                        msg="Element 'constraintComponents' must not have attributes."
                        msgOK="OK - 'constraintComponents' element: no attributes."/>
                    <ex:allowedElems 
                        elemNames="constraintComponent"
                        msg="Unexpected child element in 'constraintComponents' element: only 'constraintComponent' children allowed"
                        msgOK="OK - 'constraintComponents element: child element names"/>
                    
                    <!-- check <constraintComponent>
                        ============================ -->                    
                    <focusNode xpath="*:constraintComponent">
                        <ex:mandatoryAtts 
                            attNames="constraintElementName"
                            msg="Missing mandatory attributes in 'constraintComponent' element; expected: constraintElementName"
                            msgOK="OK - 'constraintElement' element: with mandatory attribute 'constraintElementName'"/>                        
                    </focusNode>
                    
                </focusNode>
                
                
                <!-- check <domain>
                     ============== -->
                <focusNode xpath="*:greenfox/*:domain">
                    <targetSize minCount="1" minCountMsg="No domain"
                        minCountMsgOK="OK - domain found"/>

                    <!-- check attribute names, mandatory atts -->
                    <ex:allowedAtts attNames="path name"
                        msg="Unexpected attributes in 'domain' element; expected: path, name"
                        msgOK="OK - 'domain' element: no unexpected attributes"/>
                    <ex:mandatoryAtts attNames="path name"
                        msg="Missing mandatory attributes in 'domain' element; expected: path, name"
                        msgOK="OK - 'domain' element: with mandatory attributes ('path' and 'name')"/>

                    <xpath description="Validates the @path value" expr="@path" matches="\\|\{.*\}"
                        matchesMsg="Path value must use backslashes, reference external variables"
                        matchesMsgOK="OK - 'domain' element: @path uses backslashes" notMatches="/"
                        notMatchesMsg="Path value must not use slashes, only backslashes"
                        notMatchesMsgOK="OK - 'domain' element: @path does not contain slashes"
                        deactivated="false"> </xpath>
                </focusNode>

                <!-- check <folder>
                     ============== -->
                <focusNode xpath="//*:folder">

                    <!-- attribute names -->
                    <ex:allowedAtts attNames="foxpath path id"
                        msg="Unexpected attributes in 'folder' element; expected: foxpath, path, id"
                        msgOK="OK - 'folder' element: no unexpected attributes"/>
                    
                    <!-- mandatory attributes -->
                    <ex:xoneAtts attNames="foxpath path"
                        msg="A 'folder' shape must exactly one of these attributes: foxpath, path"
                        msgOK="OK - 'folder' element: has foxpath or path"/>
                    
                    <!-- element names -->
                    <ex:allowedElems elemNames="targetSize file folder folderContent foxpath"
                        msg="Unexpected elements in 'folder' element; expected: targetSize file folder folderContent foxpath"
                        msgOK="OK - 'folder' element: no unexpected elements"/>
                    
                    <!-- @foxpath must not start with \ -->
                    <xpath expr="@foxpath"
                           notMatches="^\\"
                           notMatchesMsg="A foxpath expression on 'folder' must be relative, must not start with a backslash"
                           notMatchesMsgOK="OK - 'folder' @foxpath does not start with a backslash"/>
                    
                </focusNode>

                <!-- check <targetSize>
                     ================== -->
                <focusNode xpath="//*:targetSize">
                    
                    <!-- attribute names -->
                    <ex:allowedAtts
                        attNames="count minCount maxCount msg countMsg countMsgOK minCountMsg minCountMsgOK maxCountMsg maxCountMsgOK id"
                        msg="Unexpected attributes in 'targetSize' element; expected: $attNames"
                        msgOK="OK - 'folder' element: no unexpected attributes"/>
                    
                    <!-- mandatory attributes -->
                    <ex:oneOrMoreAtts 
                        attNames="minCount maxCount count"
                        msg="A 'targetSize' shape must contains at least one of these attributes: $attNames"
                        msgOK="OK - 'targetSize' element: has at least one of these attributes: $attNames"/>
                    
                    <!-- check value @minCount -->
                    <xpath description="Check attribute values, 'minCount'" expr="@minCount"
                        datatype="integer"
                        datatypeMsg="Element 'targetSize', attributes 'minCount' must have integer values"
                        datatypeMsgOK="OK - 'targetSize' element: no @minCount atts with non-integer type"
                        ge="0" geMsg="Element 'targetSize', attributes 'minCount' must be ge 0"
                        geMsgOK="OK - 'targetSize' element: no @minCount atts lt 0"/>
                    
                    <!-- check values @maxCount, @count -->
                    <xpath description="Check attribute values, 'maxCount, count"
                        expr="(@maxCount, @count)" matches="^\d+|\*$"
                        matchesMsg="Element 'targetSize', attributes 'maxCount' and 'count' must have integer values or be '*'"
                        matchesMsgOK="OK - 'targetSize' element: no @maxCount or @count atts with non-integer values ne '*'"/>
                    
                    <!-- all child elements must be empty -->
                    <ex:emptyElem
                        msg="Element 'targetSize' must be empty'"
                        msgOK="OK - 'targetSize' element empty"/>
                    
                    
                    <!-- check empty content -->
                    <!--
                    <xpath description="Validates content of 'targetSize' elements" expr="*"
                        maxCount="0"
                        maxCountMsg="Unexpected child element found in 'targetSize' element - 'targetSize' must be empty"
                        maxCountMsgOK="OK - 'targetSize' element: empty" deactivated="false"/>
                        -->
                </focusNode>

                <!-- check <folderContent>
                     ===================== -->
                <focusNode xpath="*:greenfox//*:folderContent">
                    
                    <!-- attribute names -->
                    <ex:allowedAtts 
                        attNames="id closed closedMsg closedMsgOK"
                        msg="Unexpected attributes in 'folderContent' element; expected: $attNames"
                        msgOK="OK - 'folderContent' element: no unexpected attributes"/>
                    
                    <!-- mandatory attributes -->
                    <ex:allowedElems
                        elemNames="memberFile memberFiles 
                                   memberFolder memberFolders 
                                   excludedMemberFile excludedMemberFiles 
                                   excludedMemberFolder excludedMemberFolders"
                        msg="Unexpected elements in 'folderContent' element; expected: $elemNames"
                        msgOK="OK - 'folderContent' element: no unexpected child elements"/>

                    <!-- all child elements must be empty -->
                    <focusNode xpath="*">
                        <ex:emptyElem
                            msg="Child elements of 'folderContent' must be empty'"
                            msgOK="OK - child elements of 'folderContent' empty"/>
                    </focusNode>
                    
                    <!-- <memberFile>, <memberFolder> 
                         ............................ -->
                    <focusNode xpath="*:memberFile, *:memberFolder">
                        
                        <!-- attribute names -->
                        <ex:allowedAtts
                            attNames="name 
                            count countMsg countMsgOK
                            minCount minCountMsg minCountMsgOK
                            maxCount maxCountMsg maxCountMsgOK
                            md5 md5Msg msg5MsgOK
                            sha1 sha1Msg sha1MsgOK
                            sha256 sha256Msg sha256MsgOK"
                            msg="Unexpected attributes in 'memberFile' or 'memberFolder' element; expected: $attNames"
                            msgOK="OK - 'memberFile' or 'memberFolder' element: no unexpected attributes"/>
                        
                        <!-- mandatory attributes -->                    
                        <ex:mandatoryAtts 
                            attNames="name"
                            msg="Missing mandatory attribute in 'memberFile' or 'memberFolder' element: name"
                            msgOK="OK - 'memberFile' or 'memberFolder' element: with mandatory attribute 'name'"/>
                    </focusNode>
                    
                    <!-- <memberFiles>, <memberFolders> 
                         .............................. -->
                    <focusNode xpath="*:memberFiles, *:memberFolders">
                        
                        <!-- attribute names -->
                        <ex:allowedAtts
                            attNames="names 
                            count countMsg countMsgOK
                            minCount minCountMsg minCountMsgOK
                            maxCount maxCountMsg maxCountMsgOK
                            md5 md5Msg msg5MsgOK
                            sha1 sha1Msg sha1MsgOK
                            sha256 sha256Msg sha256MsgOK"
                            msg="Unexpected attributes in 'memberFile' or 'memberFolder' element; expected: $attNames"
                            msgOK="OK - 'memberFile' or 'memberFolder' element: no unexpected attributes"/>
                        
                        <!-- mandatory attributes -->
                        <ex:mandatoryAtts 
                            attNames="names"
                            msg="Missing mandatory attribute in 'memberFile' or 'memberFolder' element: names"
                            msgOK="OK - 'memberFile' or 'memberFolder' element: with mandatory attribute 'names'"
                        />
                    </focusNode>

                    <!-- <excludedMemberFile>, <excludedMemberFolder> 
                         ............................................ -->
                    <focusNode
                        xpath="*:excludedMemberFile, *:excludedMemberFolder">
                        
                        <!-- attribute names -->
                        <ex:allowedAtts 
                            attNames="name"
                            msg="Unexpected attributes in 'excludedMemberFile' or 'excludedMemberFolder' element; expected: $attNames"
                            msgOK="OK - 'excludedMemberFile' or 'excludedMemberFolder' element: no unexpected attributes"/>
                        
                        <!-- mandatory atts -->
                        <ex:mandatoryAtts 
                            attNames="name"
                            msg="Missing mandatory attribute in 'excludedMemberFile' or 'excludedMemberFolder' element: name"
                            msgOK="OK - 'excludedMemberFile' or 'excludedMemberFolder' element: with mandatory attribute 'name'"
                        />
                    </focusNode>

                    <!-- <excludedMemberFiles>, <excludedMemberFolders> 
                         .............................................. -->
                    <focusNode
                        xpath="*:excludedMemberFiles, *:excludedMemberFolders">
                        
                        <!-- attribute names -->
                        <ex:allowedAtts 
                            attNames="names"
                            msg="Unexpected attributes in 'excludedMemberFiles' or 'excludedMemberFolders' element; expected: $attNames"
                            msgOK="OK - 'excludedMemberFiles' or 'excludedMemberFolders' element: no unexpected attributes"/>
                        
                        <!-- mandatory atts -->
                        <ex:mandatoryAtts 
                            attNames="names"
                            msg="Missing mandatory attribute in 'excludedMemberFiles' or 'excludedMemberFolders' element: names"
                            msgOK="OK - 'excludedMemberFiles' or 'excludedMemberFolders' element: with mandatory attribute 'names'"
                        />
                    </focusNode>
                    
                </focusNode>


                <!-- check <file>
                     ============ -->
                <!-- <file> - check attribute names -->
                <xpath description="Validates the attribute names in 'file' elements"
                    expr="*:greenfox//*:file/@*/name()"
                    inMsg="Unexpected attribute in 'file' element; expected names: foxpath, id"
                    inMsgOK="OK - 'file' element: no unexpected attribute names" deactivated="false">
                    <in>
                        <eq>foxpath</eq>
                        <eq>id</eq>
                        <eq>mediatype</eq>
                        <eq>csv.separator</eq>
                        <eq>csv.withHeader</eq>
                    </in>
                </xpath>



            </file>
        </folder>
    </domain>
</greenfox>
